from __init__ import *

class CheckableFileSystemModel(QFileSystemModel):
    checkStateChanged = pyqtSignal(str, bool)
    def __init__(self):
        super().__init__()
        #list of checkstates
        self.checklist = []
        self.checkStates = {}
        self.setNameFilterDisables(False)

        #Functions used in the checking procedure
        self.rowsInserted.connect(self.AddCheckMark)
        self.rowsRemoved.connect(self.RemoveCheckMark)
        self.rowsAboutToBeRemoved.connect(self.RemoveCheckMark)

    #Returns the state of the index
    def checkState(self, index):
        return self.checkStates.get(self.filePath(index), Qt.Unchecked)

    #Sets the state of the checkbox, while making sure it is not overwritten an equal state and emits the change if needed
    def AddCheckMark(self, index, state, emitStateChange=True):
        path = self.filePath(index)
        if self.checkStates.get(path) == state:
            return
        self.checklist.append(self.filePath(index))
        self.checkStates[path] = state
        if emitStateChange:
            self.checkStateChanged.emit(path, bool(state))

    #Removing a checkmark from the file
    def RemoveCheckMark(self, index):
        if not index.isValid():
            return
        path = self.filePath(index)
        if path in self.checkStates:
            self.checkStates.pop(path)
            for i in self.checklist:
                if self.checklist[i] == path:
                    self.checklist[i].pop()

    def flags(self, index):
            return super().flags(index) | Qt.ItemIsUserCheckable

    def data(self, index, role=Qt.DisplayRole):
        if role == Qt.CheckStateRole and index.column() == 0 and self.isDir(index) == False:
            return self.checkState(index)
        return super().data(index, role)

    #Setting the data of chosen index with a given value
    def setData(self, index, value, role, emitStateChange=True):
        if role == Qt.CheckStateRole and index.column() == 0:
            self.AddCheckMark(index, value, emitStateChange)
            self.dataChanged.emit(index, index)
            return True
        return super().setData(index, value, role)

class Tree(QWidget):
    def __init__(self):
        super(Tree, self).__init__()
        self.layout = QVBoxLayout(self)

        self.tree = QTreeView()
        self.layout.addWidget(self.tree)


        self.model = CheckableFileSystemModel()
        self.model.setRootPath('')
        self.model.setNameFilters(["*.jpg", "*.png", "*.jpeg"])
        self.tree.setModel(self.model)
        self.tree.setSortingEnabled(True)
        self.tree.header().setSectionResizeMode(QHeaderView.ResizeToContents)
        self.tree.setItemsExpandable(False)
        self.tree.setContextMenuPolicy(Qt.ActionsContextMenu)
        returnToParentDir = QAction("Go Back", self)
        returnToParentDir.triggered.connect(lambda: self.returnToParent())
        self.tree.addAction(returnToParentDir)

        chooseDir = QAction("Set as root", self)
        chooseDir.triggered.connect(lambda: self.choose_dir(self.tree.currentIndex()))
        self.tree.addAction(chooseDir)

        self.tree.doubleClicked.connect(self.doubleClickAction)


    def doubleClickAction(self):
        self.tree.setRootIndex(self.tree.currentIndex())

    def returnToParent(self):
        self.tree.setRootIndex(self.tree.rootIndex().parent())

    def choose_dir(self, index):
        self.tree.setRootIndex(index)


